---
title: "Relative Proportion of Intermediate Methylation (RPIM)"
author: "Nathan Sheffield & VP Nagraj"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Relative Proportion of Intermediate Methylation (RPIM)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = F}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```

## Overview

RPIM is a score that measures the epigenetic heterogeneity in a bisulfite sequencing sample. Under the assumption that a homogeneous sample will have mostly CpGs with either 0 or 100 percent DNA methylation, it follows that the proportion of sites that differ from these two extremes can be used as a measure of sample heterogeneity.

## Intermediate Methylation

We define a site as IM (Intermediate Methylation) if its credibility interval is not completely below .25, or above .75. Other sites are more likely to be either 0 or 1 (or very close).

- histogram of methylation to demonstrate IM?
- scientific application / interpretation of IM?

## Data Preparation

- BSDT 
- `MIRA::BSreadBiSeq()`
- `MIRA::bsseqToDataTable()`
- show some example data

## PIM

- PIM explained
- forumla
- example calculation

## RPIM

- RPIM explained
- forumla
- example calculation

## Caching

```{r, eval = F}
# devtools::install_github("databio/MIRA")
# devtools::install_github("databio/simpleCache")

library(RPIM)

dat = MIRA::BSreadBiSeq("data/RRBS_cpgMethylation_EWS_L10.bed")

# have to setSharedCacheDir()
simpleCache::setSharedCacheDir("cache")

imres = calculatePIM(dat)

###############################

# relative proportion of sites

dat2 = MIRA::BSreadBiSeq("data/RRBS_cpgMethylation_EWS_T133.bed")
dat3 = MIRA::BSreadBiSeq("data/RRBS_cpgMethylation_EWS_T111.bed")
dat4 = MIRA::BSreadBiSeq("data/RRBS_cpgMethylation_EWS_T120.bed")

alldat = rbind(dat,dat2, dat3, dat4)
allsplitdat = split(alldat, alldat$sampleName)

RPIM(allsplitdat)

# try this with bsseq object
# source("https://bioconductor.org/biocLite.R")
# biocLite("bsseqData")

library(bsseqData)
data(BS.cancer.ex)

bsseqdat = MIRA::bsseqToDataTable(BS.cancer.ex)

RPIM(bsseqdat, cacheDir = "foo")

```
